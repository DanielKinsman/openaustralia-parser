# Capistrano 2.x recipe file
#
# Requirement cap 2.1

set :application, "openaustralia-app"

set :scm, :git
set :scm_command, "/opt/local/bin/git"
# This works even when the remote server does not have git installed
set :deploy_via, :copy

# default_run_options[:pty] = true

set :repository, "/Library/WebServer/Documents/openaustralia-app"

set :use_sudo, false

# Use the following settings for a "true" deploy
set :deploy_to, "/home/3716/domains/openaustralia.org/#{application}"
role :web, "openaustralia.org"
set :user, "serveradmin%openaustralia.org"

# Use the following settings for a test local deploy
#set :deploy_to, "/Library/WebServer/Documents/test-deploy/#{application}"
#role :web, "localhost"
#set :user, "matthewl"

load 'deploy' if respond_to?(:namespace) # cap2 differentiator

namespace :deploy do
	task :setup, :except => { :no_release => true } do
		dirs = [deploy_to, releases_path, shared_path]
		shared_images_path = File.join(shared_path, "images")
		dirs += ["mps", "mpsL"].map {|d| File.join(shared_images_path, d)}
		run "umask 02 && mkdir -p #{dirs.join(' ')}"
	end

	# Do nothing for deploy:restart
	task :restart do
	end

	task :finalize_update, :except => { :no_release => true } do
		run "chmod -R g+w #{latest_release}" if fetch(:group_writable, true)
	end

	desc "After a code update, we link the images directories to the shared ones"
	task :after_update_code, :except => { :no_release => true} do
		run "rm -rf #{release_path}/twfy/www/docs/images/mps #{release_path}/twfy/www/docs/images/mpsL #{release_path}/twfy/conf/general"
		run "ln -s #{shared_path}/images/mps #{release_path}/twfy/www/docs/images/mps"
		run "ln -s #{shared_path}/images/mpsL #{release_path}/twfy/www/docs/images/mpsL"
		run "ln -s #{shared_path}/general #{release_path}/twfy/conf/general"
	end
end
